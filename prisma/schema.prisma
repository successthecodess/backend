generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model AdminEmail {
  id        String   @id @default(cuid())
  email     String   @unique
  addedBy   String   // Email of admin who added this
  addedAt   DateTime @default(now())
  isActive  Boolean  @default(true)
  
  @@index([email])
  @@map("admin_emails")
}

model FreeTrialQuestion {
  id          String   @id @default(cuid())
  questionId  String
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  orderIndex  Int      @unique // 1-10
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([orderIndex])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String   // LOGIN, ADMIN_GRANT, TAG_ADD, etc.
  resource  String?  // user:123, question:456, etc.
  success   Boolean
  ipAddress String?
  userAgent String?
  metadata  Json?    // Additional context
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([success])
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  name              String?
  password          String?
  passwordSetAt    DateTime?
  
  phone     String?
  refreshTokens   RefreshToken[]  
  fullExamAttempts    FullExamAttempt[]
  auditLogs       AuditLog[] 
  hasUsedFreeTrial Boolean @default(false)
  freeTrialCompletedAt DateTime?
  subscriptionStatus   SubscriptionStatus  @default(FREE)
  subscriptionId       String?             // Stripe subscription ID
  stripeCustomerId     String?             // Stripe customer ID
  subscriptionEndsAt   DateTime?
  lastPaymentDate      DateTime?
  ghlUserId         String?   @unique
  ghlAccessToken    String?   @db.Text
  ghlRefreshToken   String?   @db.Text
  ghlTokenExpiry    DateTime?
  ghlLocationId     String?
  ghlCompanyId      String?
  ghlTags           String[]           @default([])
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  isPremium         Boolean            @default(false)
  lastActive        DateTime           @default(now())
  premiumUntil      DateTime?
  role              UserRole           @default(STUDENT)
  isAdmin           Boolean            @default(false) 
  isStaff           Boolean            @default(false)
  hasAccessToQuestionBank Boolean       @default(false)
  hasAccessToTimedPractice Boolean      @default(false)
  hasAccessToAnalytics     Boolean      @default(false)
  examAttempts      ExamAttempt[]
  progress          Progress[]
  questionResponses QuestionResponse[]
  studySessions     StudySession[]
  achievements      UserAchievement[]

  @@index([email])
  @@index([subscriptionStatus])
  @@map("users")
}
enum SubscriptionStatus {
  FREE
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}
model GHLCompanyAuth {
  id              String   @id @default(cuid())
  companyId       String   @unique
  locationId      String?
  accessToken     String   @db.Text
  refreshToken    String   @db.Text
  tokenExpiry     DateTime
  authorizedBy    String   // Admin who authorized
  authorizedAt    DateTime @default(now())
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([companyId])
}

model PlatformSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  category  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Unit {
  id          String     @id @default(cuid())
  unitNumber  Int        @unique
  name        String
  description String?
  createdAt   DateTime   @default(now())
  color       String?
  icon        String?
  isActive    Boolean    @default(true)
  orderIndex  Int        @default(0)
  updatedAt   DateTime   @updatedAt
  progress    Progress[]
  questions   Question[]
  topics      Topic[]

  @@index([unitNumber])
  @@index([isActive])
  @@map("units")
}

model Topic {
  id                 String     @id @default(cuid())
  name               String
  description        String?
  unitId             String
  createdAt          DateTime   @default(now())
  isActive           Boolean    @default(true)
  learningObjectives String[]
  orderIndex         Int        @default(0)
  prerequisites      String[]
  updatedAt          DateTime   @updatedAt
  progress           Progress[]
  questions          Question[]
  unit               Unit       @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([isActive])
  @@map("topics")
}

model Question {
  id                  String             @id @default(cuid())
  unitId              String
  topicId             String?
  freeTrialQuestions   FreeTrialQuestion[] 
  examAttemptMCQs     ExamAttemptMCQ[]
  type                QuestionType
  difficulty          DifficultyLevel
  questionText        String
  options             Json?
  correctAnswer       String
  explanation         String
  aiGenerated         Boolean            @default(false)
  approved            Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  apLearningObjective String?
  apSkillCategory     String?
  averageTime         Float?
  bloomsLevel         String?
  codeSnippet         String?
  estimatedTime       Int?
  hints               Json?
  isActive            Boolean            @default(true)
  qualityScore        Float?
  tags                String[]
  timesAttempted      Int                @default(0)
  timesCorrect        Int                @default(0)
  examQuestions       ExamQuestion[]
  responses           QuestionResponse[]
  topic               Topic?             @relation(fields: [topicId], references: [id])
  unit                Unit               @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId, difficulty])
  @@index([topicId, difficulty])
  @@index([approved, isActive])
  @@index([aiGenerated])
  @@index([unitId, approved, difficulty])
  @@index([unitId, approved])
  @@index([unitId, approved, isActive, difficulty])
  @@index([unitId, topicId, approved, isActive])
  @@map("questions")
}

model Progress {
  id                     String          @id @default(cuid())
  userId                 String
  unitId                 String
  topicId                String?
  currentDifficulty      DifficultyLevel @default(EASY)
  totalAttempts          Int             @default(0)
  correctAttempts        Int             @default(0)
  lastPracticed          DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  averageTimePerQuestion Float?
  commonMistakes         Json?
  confidenceScore        Float           @default(0)
  consecutiveCorrect     Int             @default(0)
  consecutiveWrong       Int             @default(0)
  createdAt              DateTime        @default(now())
  easeFactor             Float           @default(2.5)
  interval               Int             @default(1)
  masteryLevel           Float           @default(0)
  nextReviewDate         DateTime?
  reviewCount            Int             @default(0)
  strugglingTopics       Json?
  totalTimeSpent         Int             @default(0)
  topic                  Topic?          @relation(fields: [topicId], references: [id])
  unit                   Unit            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  user                   User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, unitId, topicId], map: "userId_unitId_topicId")
  @@index([userId, masteryLevel])
  @@index([nextReviewDate])
  @@index([userId, unitId, topicId])
  @@map("progress")
}

model QuestionResponse {
  id               String          @id @default(cuid())
  userId           String
  questionId       String
  userAnswer       String
  isCorrect        Boolean
  timeSpent        Int?
  createdAt        DateTime        @default(now())
  attemptNumber    Int             @default(1)
  difficultyAtTime DifficultyLevel
  examAttemptId    String?
  flaggedForReview Boolean         @default(false)
  hintsUsedCount   Int             @default(0)
  notes            String?
  partialCredit    Float?
  sessionId        String?
  startedAt        DateTime        @default(now())
  submittedAt      DateTime        @default(now())
  usedHints        Boolean         @default(false)
  userConfidence   Int?
  question         Question        @relation(fields: [questionId], references: [id], onDelete: Cascade)
  studySession     StudySession?   @relation(fields: [sessionId], references: [id])
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, questionId])
  @@index([userId, isCorrect])
  @@index([sessionId])
  @@map("question_responses")
}

model StudySession {
  id              String             @id @default(cuid())
  userId          String
  unitId          String?
  topicId         String?
  sessionType     SessionType        @default(PRACTICE)
  totalQuestions  Int                @default(0)
  correctAnswers  Int                @default(0)
  averageTime     Float?
  accuracyRate    Float?
  startedAt       DateTime           @default(now())
  endedAt         DateTime?
  totalDuration   Int?
  targetQuestions Int?
  targetAccuracy  Float?
  goalAchieved    Boolean            @default(false)
  notes           String?
  createdAt       DateTime           @default(now())
  responses       QuestionResponse[]
  aiSummary     String?
  metadata         Json?
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startedAt])
  @@index([userId, endedAt])
  @@index([sessionType])
  @@map("study_sessions")
}

model Exam {
  id                     String         @id @default(cuid())
  name                   String
  description            String?
  totalQuestions         Int
  duration               Int
  unitDistribution       Json
  isPremium              Boolean        @default(false)
  createdAt              DateTime       @default(now())
  createdBy              String?
  difficultyDistribution Json?
  examType               ExamType       @default(PRACTICE)
  frqCount               Int            @default(0)
  isActive               Boolean        @default(true)
  isPublished            Boolean        @default(false)
  mcqCount               Int            @default(0)
  passingScore           Float?
  scoreRanges            Json?
  updatedAt              DateTime       @updatedAt
  version                String         @default("1.0")
  attempts               ExamAttempt[]
  questions              ExamQuestion[]

  @@index([examType, isPublished])
  @@index([isPremium])
  @@map("exams")
}

model ExamQuestion {
  id         String   @id @default(cuid())
  examId     String
  questionId String
  orderIndex Int
  createdAt  DateTime @default(now())
  points     Float    @default(1)
  section    String?
  exam       Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([examId, orderIndex])
  @@index([examId])
  @@map("exam_questions")
}

model ExamAttempt {
  id                  String     @id @default(cuid())
  userId              String
  examId              String
  predictedAPScore    Int?
  startedAt           DateTime   @default(now())
  responses           Json
  confidenceData      Json?
  createdAt           DateTime   @default(now())
  difficultyBreakdown Json?
  frqScore            Float?
  mcqScore            Float?
  percentageScore     Float?
  rawScore            Float?
  recommendations     Json?
  reviewNotes         String?
  reviewedAt          DateTime?
  status              ExamStatus @default(IN_PROGRESS)
  strengths           String[]
  submittedAt         DateTime?
  timeByQuestion      Json?
  timeSpent           Int?
  topicBreakdown      Json?
  unitBreakdown       Json?
  updatedAt           DateTime   @updatedAt
  weaknesses          String[]
  exam                Exam       @relation(fields: [examId], references: [id], onDelete: Cascade)
  user                User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([examId, predictedAPScore])
  @@map("exam_attempts")
}

model DailyAnalytics {
  id                 String   @id @default(cuid())
  userId             String
  date               DateTime @db.Date
  questionsAttempted Int      @default(0)
  questionsCorrect   Int      @default(0)
  studyTime          Int      @default(0)
  sessionsCount      Int      @default(0)
  averageAccuracy    Float?
  averageTime        Float?
  studyStreak        Int      @default(0)
  perfectDays        Int      @default(0)
  unitsStudied       String[]
  topicsStudied      String[]
  dailyGoalMet       Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
  @@map("daily_analytics")
}

model WeeklyAnalytics {
  id                 String   @id @default(cuid())
  userId             String
  weekStart          DateTime @db.Date
  weekEnd            DateTime @db.Date
  totalQuestions     Int      @default(0)
  totalCorrect       Int      @default(0)
  totalStudyTime     Int      @default(0)
  averageAccuracy    Float?
  accuracyTrend      String?
  mostImprovedUnit   String?
  needsAttentionUnit String?
  activeDays         Int      @default(0)
  longestStreak      Int      @default(0)
  peakStudyDay       String?
  unitsCovered       String[]
  topicsMastered     String[]
  createdAt          DateTime @default(now())

  @@unique([userId, weekStart])
  @@index([userId, weekStart])
  @@map("weekly_analytics")
}

model Achievement {
  id               String              @id @default(cuid())
  name             String              @unique
  description      String
  category         AchievementCategory
  icon             String?
  points           Int                 @default(0)
  criteria         Json
  rarity           String              @default("common")
  isActive         Boolean             @default(true)
  createdAt        DateTime            @default(now())
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  progress      Float       @default(0)
  isUnlocked    Boolean     @default(false)
  unlockedAt    DateTime?
  isDisplayed   Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, isUnlocked])
  @@map("user_achievements")
}

model ContentReview {
  id             String       @id @default(cuid())
  questionId     String
  reviewerId     String
  status         ReviewStatus
  qualityScore   Int?
  feedback       String?
  suggestedEdits Json?
  hasErrors      Boolean      @default(false)
  needsRevision  Boolean      @default(false)
  reviewedAt     DateTime     @default(now())

  @@index([questionId, status])
  @@map("content_reviews")
}

model FeatureFlag {
  id              String   @id @default(cuid())
  name            String   @unique
  displayName     String
  description     String?
  requiredGhlTag  String?
  requiresPremium Boolean  @default(false)
  requiresStaff   Boolean  @default(false)
  isEnabled       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([name])
  @@map("feature_flags")
}

model CourseAccess {
  id              String   @id @default(cuid())
  courseName      String
  courseSlug      String   @unique
  requiredGhlTag  String
  fallbackToFlag  String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([courseSlug])
  @@index([requiredGhlTag])
  @@map("course_access")
}

model ExamBankQuestion {
  id            String            @id @default(cuid())
  questionId    String?           // NEW: Link to practice question for imports
  unitId        String
  unit          ExamUnit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  questionType  ExamQuestionType
  frqType       FRQType?
  
  questionText  String            @db.Text
  
  options       Json?
  correctAnswer String?
  
  promptText    String?           @db.Text
  starterCode   String?           @db.Text
  frqParts      Json?
  maxPoints     Int               @default(9)
  
  explanation   String?           @db.Text
  difficulty    ExamDifficulty    @default(MEDIUM)
  approved      Boolean           @default(false)
  aiGenerated   Boolean           @default(false)
  isActive      Boolean           @default(true)
  
  timesUsed     Int               @default(0)
  averageScore  Float?
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  mcqAttempts   ExamAttemptMCQ[]
  frqAttempts   ExamAttemptFRQ[]
  
  @@index([unitId])
  @@index([questionType])
  @@index([frqType])
  @@index([approved])
  @@index([questionId])
}

model ExamAttemptFRQ {
  id                String           @id @default(cuid())
  examAttemptId     String
  examAttempt       FullExamAttempt  @relation(fields: [examAttemptId], references: [id], onDelete: Cascade)
  questionId        String
  question          ExamBankQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  frqNumber         Int
  
  userCode          String?          @db.Text
  partResponses     Json?
  
  aiEvaluated       Boolean          @default(false)
  aiEvaluationResult Json?
  aiComments        String?          @db.Text
  rubricBreakdown   Json?            // NEW: Store rubric scores
  
  manualScore       Float?
  manualComments    String?          @db.Text
  reviewedBy        String?
  reviewedAt        DateTime?
  
  finalScore        Float?
  timeSpent         Int?
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@unique([examAttemptId, frqNumber])
  @@index([questionId])
}

model ExamUnit {
  id              String              @id @default(cuid())
  unitNumber      Int                 @unique
  name            String
  description     String?
  examWeight      String
  topics          String[]
  
  questions       ExamBankQuestion[]
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  isActive        Boolean             @default(true)
  
  @@index([unitNumber])
  @@map("exam_units")
}

model FullExamAttempt {
  id                  String              @id @default(cuid())
  userId              String
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  attemptNumber       Int                 @default(1) 
  startedAt           DateTime            @default(now())
  submittedAt         DateTime?
  status              FullExamStatus      @default(IN_PROGRESS)
  totalTimeSpent      Int?
  
  mcqResponses        ExamAttemptMCQ[]
  mcqScore            Int?
  mcqPercentage       Float?
  
  frqResponses        ExamAttemptFRQ[]
  frqTotalScore       Float?
  frqPercentage       Float?
  
  rawScore            Float?
  percentageScore     Float?
  predictedAPScore    Int?
  
  unitBreakdown       Json?
  strengths           String[]
  weaknesses          String[]
  recommendations     Json?
  
  gradingProgress     Json?               // NEW: Track grading progress
  
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  @@index([userId, status])
  @@index([userId, attemptNumber])
  @@index([predictedAPScore])
  @@map("full_exam_attempts")
}

model ExamAttemptMCQ {
  id                  String              @id @default(cuid())
  examAttemptId       String
  examAttempt         FullExamAttempt     @relation(fields: [examAttemptId], references: [id], onDelete: Cascade)
  
  // Support both question sources
  questionId          String?             // ExamBankQuestion (for FRQ or legacy)
  question            ExamBankQuestion?   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  practiceQuestionId  String?             // Question (unified MCQ)
  practiceQuestion    Question?           @relation(fields: [practiceQuestionId], references: [id], onDelete: Cascade)
  
  orderIndex          Int
  userAnswer          String?
  isCorrect           Boolean?
  timeSpent           Int?
  
  flaggedForReview    Boolean             @default(false)
  
  createdAt           DateTime            @default(now())
  
  @@unique([examAttemptId, orderIndex])
  @@index([examAttemptId])
  @@index([practiceQuestionId])
  @@map("exam_attempt_mcqs")
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
  INSTRUCTOR 
  SUPER_ADMIN 
}

enum QuestionType {
  MULTIPLE_CHOICE
  FREE_RESPONSE
  CODE_COMPLETION
  CODE_ANALYSIS
  TRUE_FALSE
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum SessionType {
  PRACTICE
  EXAM
  REVIEW
  TIMED_DRILL
  ADAPTIVE
  FREE_TRIAL
  MIXED_PRACTICE
}

enum ExamType {
  PRACTICE
  DIAGNOSTIC
  UNIT_TEST
  FINAL_PRACTICE
  MOCK_AP
}

enum ExamStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  UNDER_REVIEW
}

enum AchievementCategory {
  STREAK
  MASTERY
  EXAM
  PRACTICE
  SPEED
  ACCURACY
  DEDICATION
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REVISION
}

enum ExamQuestionType {
  MCQ
  FRQ
}

enum FRQType {
  METHODS_CONTROL
  CLASSES
  ARRAYLIST
  TWO_D_ARRAY
}

enum ExamDifficulty {
  EASY
  MEDIUM
  HARD
}

enum FullExamStatus {
  IN_PROGRESS
  SUBMITTED
  GRADING          // NEW: Added for parallel grading
  GRADED
  ABANDONED
}