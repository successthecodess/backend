generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
model AdminEmail {
  id        String   @id @default(cuid())
  email     String   @unique
  addedBy   String   // Email of admin who added this
  addedAt   DateTime @default(now())
  isActive  Boolean  @default(true)
  
  @@index([email])
  @@map("admin_emails")
}
model User {
  id                String             @id @default(cuid())
  email             String             @unique
  name              String?
  password          String?
  ghlUserId         String?   @unique
  ghlAccessToken    String?   @db.Text
  ghlRefreshToken   String?   @db.Text
  ghlTokenExpiry    DateTime?
  ghlLocationId     String?
  ghlCompanyId      String?
  ghlTags           String[]           @default([])
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  isPremium         Boolean            @default(false)
  lastActive        DateTime           @default(now())
  premiumUntil      DateTime?
  role              UserRole           @default(STUDENT)
  isAdmin           Boolean            @default(false) 
  isStaff           Boolean            @default(false)
  hasAccessToQuestionBank Boolean       @default(false)
  hasAccessToTimedPractice Boolean      @default(false)
  hasAccessToAnalytics     Boolean      @default(false)
  examAttempts      ExamAttempt[]
  progress          Progress[]
  questionResponses QuestionResponse[]
  studySessions     StudySession[]
  achievements      UserAchievement[]

  @@index([email])
  @@map("users")
}
model GHLCompanyAuth {
  id              String   @id @default(cuid())
  companyId       String   @unique
  locationId      String?
  accessToken     String   @db.Text
  refreshToken    String   @db.Text
  tokenExpiry     DateTime
  authorizedBy    String   // Admin who authorized
  authorizedAt    DateTime @default(now())
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([companyId])
}

model PlatformSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  category  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Unit {
  id          String     @id @default(cuid())
  unitNumber  Int        @unique
  name        String
  description String?
  createdAt   DateTime   @default(now())
  color       String?
  icon        String?
  isActive    Boolean    @default(true)
  orderIndex  Int        @default(0)
  updatedAt   DateTime   @updatedAt
  progress    Progress[]
  questions   Question[]
  topics      Topic[]

  @@index([unitNumber])
  @@index([isActive])
  @@map("units")
}

model Topic {
  id                 String     @id @default(cuid())
  name               String
  description        String?
  unitId             String
  createdAt          DateTime   @default(now())
  isActive           Boolean    @default(true)
  learningObjectives String[]
  orderIndex         Int        @default(0)
  prerequisites      String[]
  updatedAt          DateTime   @updatedAt
  progress           Progress[]
  questions          Question[]
  unit               Unit       @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([isActive])
  @@map("topics")
}

model Question {
  id                  String             @id @default(cuid())
  unitId              String
  topicId             String?
  type                QuestionType
  difficulty          DifficultyLevel
  questionText        String
  options             Json?
  correctAnswer       String
  explanation         String
  aiGenerated         Boolean            @default(false)
  approved            Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  apLearningObjective String?
  apSkillCategory     String?
  averageTime         Float?
  bloomsLevel         String?
  codeSnippet         String?
  estimatedTime       Int?
  hints               Json?
  isActive            Boolean            @default(true)
  qualityScore        Float?
  tags                String[]
  timesAttempted      Int                @default(0)
  timesCorrect        Int                @default(0)
  examQuestions       ExamQuestion[]
  responses           QuestionResponse[]
  topic               Topic?             @relation(fields: [topicId], references: [id])
  unit                Unit               @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId, difficulty])
  @@index([topicId, difficulty])
  @@index([approved, isActive])
  @@index([aiGenerated])
  @@map("questions")
}

model Progress {
  id                     String          @id @default(cuid())
  userId                 String
  unitId                 String
  topicId                String?
  currentDifficulty      DifficultyLevel @default(EASY)
  totalAttempts          Int             @default(0)
  correctAttempts        Int             @default(0)
  lastPracticed          DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  averageTimePerQuestion Float?
  commonMistakes         Json?
  confidenceScore        Float           @default(0)
  consecutiveCorrect     Int             @default(0)
  consecutiveWrong       Int             @default(0)
  createdAt              DateTime        @default(now())
  easeFactor             Float           @default(2.5)
  interval               Int             @default(1)
  masteryLevel           Float           @default(0)
  nextReviewDate         DateTime?
  reviewCount            Int             @default(0)
  strugglingTopics       Json?
  totalTimeSpent         Int             @default(0)
  topic                  Topic?          @relation(fields: [topicId], references: [id])
  unit                   Unit            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  user                   User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, unitId, topicId], map: "userId_unitId_topicId")
  @@index([userId, masteryLevel])
  @@index([nextReviewDate])
  @@map("progress")
}

model QuestionResponse {
  id               String          @id @default(cuid())
  userId           String
  questionId       String
  userAnswer       String
  isCorrect        Boolean
  timeSpent        Int?
  createdAt        DateTime        @default(now())
  attemptNumber    Int             @default(1)
  difficultyAtTime DifficultyLevel
  examAttemptId    String?
  flaggedForReview Boolean         @default(false)
  hintsUsedCount   Int             @default(0)
  notes            String?
  partialCredit    Float?
  sessionId        String?
  startedAt        DateTime        @default(now())
  submittedAt      DateTime        @default(now())
  usedHints        Boolean         @default(false)
  userConfidence   Int?
  question         Question        @relation(fields: [questionId], references: [id], onDelete: Cascade)
  studySession     StudySession?   @relation(fields: [sessionId], references: [id])
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, questionId])
  @@index([userId, isCorrect])
  @@index([sessionId])
  @@map("question_responses")
}

model StudySession {
  id              String             @id @default(cuid())
  userId          String
  unitId          String?
  topicId         String?
  sessionType     SessionType        @default(PRACTICE)
  totalQuestions  Int                @default(0)
  correctAnswers  Int                @default(0)
  averageTime     Float?
  accuracyRate    Float?
  startedAt       DateTime           @default(now())
  endedAt         DateTime?
  totalDuration   Int?
  targetQuestions Int?
  targetAccuracy  Float?
  goalAchieved    Boolean            @default(false)
  notes           String?
  createdAt       DateTime           @default(now())
  responses       QuestionResponse[]
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startedAt])
  @@index([sessionType])
  @@map("study_sessions")
}

model Exam {
  id                     String         @id @default(cuid())
  name                   String
  description            String?
  totalQuestions         Int
  duration               Int
  unitDistribution       Json
  isPremium              Boolean        @default(false)
  createdAt              DateTime       @default(now())
  createdBy              String?
  difficultyDistribution Json?
  examType               ExamType       @default(PRACTICE)
  frqCount               Int            @default(0)
  isActive               Boolean        @default(true)
  isPublished            Boolean        @default(false)
  mcqCount               Int            @default(0)
  passingScore           Float?
  scoreRanges            Json?
  updatedAt              DateTime       @updatedAt
  version                String         @default("1.0")
  attempts               ExamAttempt[]
  questions              ExamQuestion[]

  @@index([examType, isPublished])
  @@index([isPremium])
  @@map("exams")
}

model ExamQuestion {
  id         String   @id @default(cuid())
  examId     String
  questionId String
  orderIndex Int
  createdAt  DateTime @default(now())
  points     Float    @default(1)
  section    String?
  exam       Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([examId, orderIndex])
  @@index([examId])
  @@map("exam_questions")
}

model ExamAttempt {
  id                  String     @id @default(cuid())
  userId              String
  examId              String
  predictedAPScore    Int?
  startedAt           DateTime   @default(now())
  responses           Json
  confidenceData      Json?
  createdAt           DateTime   @default(now())
  difficultyBreakdown Json?
  frqScore            Float?
  mcqScore            Float?
  percentageScore     Float?
  rawScore            Float?
  recommendations     Json?
  reviewNotes         String?
  reviewedAt          DateTime?
  status              ExamStatus @default(IN_PROGRESS)
  strengths           String[]
  submittedAt         DateTime?
  timeByQuestion      Json?
  timeSpent           Int?
  topicBreakdown      Json?
  unitBreakdown       Json?
  updatedAt           DateTime   @updatedAt
  weaknesses          String[]
  exam                Exam       @relation(fields: [examId], references: [id], onDelete: Cascade)
  user                User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([examId, predictedAPScore])
  @@map("exam_attempts")
}

model DailyAnalytics {
  id                 String   @id @default(cuid())
  userId             String
  date               DateTime @db.Date
  questionsAttempted Int      @default(0)
  questionsCorrect   Int      @default(0)
  studyTime          Int      @default(0)
  sessionsCount      Int      @default(0)
  averageAccuracy    Float?
  averageTime        Float?
  studyStreak        Int      @default(0)
  perfectDays        Int      @default(0)
  unitsStudied       String[]
  topicsStudied      String[]
  dailyGoalMet       Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
  @@map("daily_analytics")
}

model WeeklyAnalytics {
  id                 String   @id @default(cuid())
  userId             String
  weekStart          DateTime @db.Date
  weekEnd            DateTime @db.Date
  totalQuestions     Int      @default(0)
  totalCorrect       Int      @default(0)
  totalStudyTime     Int      @default(0)
  averageAccuracy    Float?
  accuracyTrend      String?
  mostImprovedUnit   String?
  needsAttentionUnit String?
  activeDays         Int      @default(0)
  longestStreak      Int      @default(0)
  peakStudyDay       String?
  unitsCovered       String[]
  topicsMastered     String[]
  createdAt          DateTime @default(now())

  @@unique([userId, weekStart])
  @@index([userId, weekStart])
  @@map("weekly_analytics")
}

model Achievement {
  id               String              @id @default(cuid())
  name             String              @unique
  description      String
  category         AchievementCategory
  icon             String?
  points           Int                 @default(0)
  criteria         Json
  rarity           String              @default("common")
  isActive         Boolean             @default(true)
  createdAt        DateTime            @default(now())
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  progress      Float       @default(0)
  isUnlocked    Boolean     @default(false)
  unlockedAt    DateTime?
  isDisplayed   Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, isUnlocked])
  @@map("user_achievements")
}

model ContentReview {
  id             String       @id @default(cuid())
  questionId     String
  reviewerId     String
  status         ReviewStatus
  qualityScore   Int?
  feedback       String?
  suggestedEdits Json?
  hasErrors      Boolean      @default(false)
  needsRevision  Boolean      @default(false)
  reviewedAt     DateTime     @default(now())

  @@index([questionId, status])
  @@map("content_reviews")
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
  INSTRUCTOR 
  SUPER_ADMIN 
}

enum QuestionType {
  MULTIPLE_CHOICE
  FREE_RESPONSE
  CODE_COMPLETION
  CODE_ANALYSIS
  TRUE_FALSE
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum SessionType {
  PRACTICE
  EXAM
  REVIEW
  TIMED_DRILL
  ADAPTIVE
}

enum ExamType {
  PRACTICE
  DIAGNOSTIC
  UNIT_TEST
  FINAL_PRACTICE
  MOCK_AP
}

enum ExamStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  UNDER_REVIEW
}

enum AchievementCategory {
  STREAK
  MASTERY
  EXAM
  PRACTICE
  SPEED
  ACCURACY
  DEDICATION
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REVISION
}
model FeatureFlag {
  id              String   @id @default(cuid())
  name            String   @unique // e.g., "question_bank", "timed_practice"
  displayName     String   // e.g., "Question Bank Access"
  description     String?
  
  // GHL Tag requirement
  requiredGhlTag  String?  // e.g., "apcs-access", "premium-apcs"
  
  // Database flag requirement
  requiresPremium Boolean  @default(false)
  requiresStaff   Boolean  @default(false)
  
  isEnabled       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([name])
  @@map("feature_flags")
}

model CourseAccess {
  id              String   @id @default(cuid())
  courseName      String   // e.g., "AP CS A", "AP CS Principles"
  courseSlug      String   @unique // e.g., "apcs-a", "apcs-principles"
  
  // Access Control
  requiredGhlTag  String   // e.g., "course-apcs-a", "course-apcs-principles"
  fallbackToFlag  String?  // Optional: check user.hasAccessToQuestionBank if tag not present
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([courseSlug])
  @@index([requiredGhlTag])
  @@map("course_access")
}

